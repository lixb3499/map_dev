- # 地图上车辆跟踪与停车区域监测 - 文档（2024年10月）

  #### 概述

  该代码实现了在地图上对车辆进行跟踪，并监测车辆是否进入或离开停车区域的功能。主要通过继承 `Tracker` 类，实现车辆的轨迹管理与状态更新，并通过 `Map` 类监控停车区域的车辆进入和离开情况。此外，代码还通过 `Area` 和 `Border` 类来定义停车区域的边界，并计算车辆与边界的交互。

  #### 类说明

  1. **`Map` 类**
     - **继承自**：`Tracker` 类，用于扩展车辆跟踪功能。
     - **主要功能**：
       - 监控多个停车区域的车辆进出情况。
       - 判断车辆是否进入或离开车道区域。
       - 提供各种统计功能，如车道进入率、车位占用率等。
       - 根据停车区域和车道的信息，实时更新车辆的状态。
     - **初始化**：
       - `content`：检测到的目标信息。
       - `area_inf_list`：停车区域的信息列表，每个元素为一个区域的坐标。
       - `lane_inf`：车道的位置信息。
     - **重要属性**：
       - `areas`：包含多个停车区域（`Area` 类）的列表。
       - `lane`：表示车道的 `Lane` 类实例。
       - `update_info`：记录每次更新时新创建的轨迹和被移除的轨迹。
     - **主要方法**：
       - `intersect(self, track, point, previous_point)`：判断车辆轨迹是否与停车区域或车道边界相交。
       - `draw_area(self, frame)`：在图像上绘制所有停车区域。
       - `nearest_area_distance(self, track, flag)`：计算轨迹距离最近的停车区域的距离。
       - `update(self, content)`：更新车辆轨迹状态，并处理新添加或消失的车辆。
       - `update_events(self)`：更新车辆进入、离开车道及停车事件，并检测车道拥堵或车辆违停情况。

  2. **`Area` 类**
     - **功能**：表示一个停车区域，由多个边界线（`Border` 类）组成。
     - **主要属性**：
       - `rectangle_left_top` 和 `rectangle_right_bottom`：定义矩形区域的左上角和右下角坐标。
       - `count_car`：当前区域内的车辆数量。
       - `border_lines`：表示停车区域的边界线（`Border` 类的实例）。
     - **主要方法**：
       - `isenter(self, point, previous_point=None)`：判断点是否进入区域。
       - `ifout(self, point, previous_point=None)`：判断点是否离开区域。
       - `intersect(self, track, point, previous_point)`：更新车辆进入或离开区域时的状态，并修改区域内的车辆计数。
       - `point_to_border_distance(self, point)`：计算给定点到停车区域边界的最小距离。
       - `draw(self, frame)`：在图像上绘制停车区域及其边界线。

  3. **`Border` 类**
     - **功能**：表示停车区域的边界线，由两个端点定义。
     - **主要属性**：
       - `point`：边界线的两个端点坐标。
       - `axis`：表示边界线的方向（'x' 或 'y'）。
       - `color`：边界线的颜色，默认黄色。
     - **主要方法**：
       - `intersect(self, point, previous_point)`：判断给定轨迹是否与边界线相交，并根据交点更新颜色和线条粗细。
       - `draw_border(self, frame)`：在图像上绘制边界线。

  4. **`Lane` 类**
     - **继承自**：`Area` 类，表示一个车道区域。
     - **功能**：扩展了 `Area` 类的功能，专门用于监控车道内的车辆流动。
     - **主要属性**：
       - `entry_event` 和 `exit_event`：记录车辆进入和离开车道的事件。
       - `traffic_congestion_event`：监控车道内的交通拥堵情况。
       - `parking_violation_event`：监控车道内的车辆违停情况。
     - **主要方法**：
       - `intersect(self, point, previous_point)`：判断车辆是否进入或离开车道区域，更新车辆计数。

  #### 主要功能流程

  1. **初始化车辆跟踪器和停车区域**
     - 在脚本开始时，创建 `Map` 类实例，用于初始化车辆跟踪器以及停车区域。
     - 停车区域信息通过 `area_inf_list` 传入，每个元素定义了一个矩形区域。
     - 车道信息通过 `lane_inf` 传入，定义车道的边界。

  2. **车辆跟踪与区域监测**
     - 每一帧图像处理时，调用 `Map` 类的 `update` 函数更新车辆的轨迹状态，并检查是否有车辆进入或离开停车区域。
     - 使用 `intersect` 方法判断车辆轨迹是否与停车区域或车道边界相交，并更新区域内的车辆计数。
     - 根据车辆的进入、离开事件，更新相关的统计数据。

  3. **事件处理与绘制**
     - `update_events` 方法更新车辆的各类事件，如进入车道、车道拥堵、违停等。
     - 通过 `draw_area` 和 `draw` 方法在每一帧图像上绘制停车区域、车道边界及车辆的轨迹。

  #### 类间关系

  - **`Map` 类继承了 `Tracker` 类**：扩展了车辆跟踪功能，增加了停车区域监测。
  - **`Area` 类包含 `Border` 类实例**：每个停车区域由多个边界线组成，`Border` 类用于判断车辆是否越界。
  - **`Lane` 类继承自 `Area` 类**：专门用于表示车道区域，并扩展了车道相关的功能，如监控车道拥堵。
