# 使用卡尔曼滤波进行目标跟踪 - 文档（update-2024年10月）

## 概述

提供的 Python 脚本通过 `Tracks` 类使用卡尔曼滤波和 IOU（交并比）来进行多目标跟踪。新加入的 `Tracker` 类管理***多个目标轨迹***，支持基于输入数据的轨迹更新、匹配与创建，以及对轨迹的状态绘制。该脚本能够适用于使用 YOLOv8 的目标跟踪，也支持手动分配 ID 进行跟踪。

## 方法概述

### 1. `content2detections(content)`

该函数从文件或其他内容中提取检测到的目标信息，返回一个包含每个检测对象信息的字典列表。

- **输入参数**：
  - `content`：文件读取的内容，通常是每行表示一个检测对象的字符串列表。
  
- **返回值**：
  - 一个字典列表，每个字典包含检测对象的以下信息：
    - `coordinate`：目标的坐标及边界框尺寸 `[x, y, w, h]`。
    - `id`：目标的唯一标识符。
    - `licence`：车牌信息（适用于车辆跟踪）。
    - `licence_cls`：车牌类别。

### 2. `iou_match(mat)`

该函数通过求解线性分配问题，使用 IOU 矩阵实现检测结果与轨迹的匹配。

- **输入参数**：
  - `mat`：轨迹与检测结果的 IOU 矩阵。
  
- **返回值**：
  - `tracks_indices`：匹配到的轨迹索引。
  - `det_indices`：匹配到的检测结果索引。

### 3. `Tracker` 类

`Tracker` 类是管理目标跟踪的主要类，负责处理多个目标的轨迹信息。

#### 3.1 初始化 `__init__(self, content, frame_rate=6)`

该方法初始化跟踪器，主要通过 `content2detections` 函数从第一帧中获取检测对象，创建 `Tracks` 实例并初始化轨迹。

- **输入参数**：
  - `content`：输入内容，包含检测目标信息的列表。
  - `frame_rate`：帧率，默认值为 6。

#### 3.2 `iou_mat(self, content)`

计算轨迹与检测对象之间的 IOU 矩阵，矩阵的大小为 `(tracks, detections)`。

- **输入参数**：
  - `content`：输入内容，用于提取检测目标信息。

- **返回值**：
  - `mat`：轨迹与检测目标的 IOU 矩阵。

#### 3.3 `update1(self, content)`

更新轨迹状态，适用于不使用 YOLOv8 提供的 ID 进行目标跟踪的情况。

- **输入参数**：
  - `content`：输入内容，包含当前帧检测到的目标信息。

- **逻辑概述**：
  - 通过 IOU 匹配轨迹与检测目标。
  - 如果轨迹没有匹配到检测目标，则标记为丢失。
  - 根据轨迹的丢失帧数，决定是否删除轨迹或创建新轨迹。

#### 3.4 `update(self, content)`

更新轨迹状态，适用于使用 YOLOv8 提供的 ID 进行目标跟踪的情况。

- **输入参数**：
  - `content`：输入内容，包含当前帧检测到的目标信息。

- **逻辑概述**：
  - 检测轨迹的 `id` 是否与检测结果匹配。
  - 如果轨迹与检测结果匹配，则更新轨迹状态。
  - 如果轨迹未匹配到检测结果，更新轨迹的丢失状态，并决定是否删除轨迹。
  - 未匹配到的检测结果将创建新的轨迹。

#### 3.5 `draw_tracks(self, img)`

在图像上绘制当前已确认的轨迹。

- **输入参数**：
  - `img`：要绘制轨迹的图像。

- **逻辑概述**：
  - 遍历所有已确认的轨迹，并在图像上绘制其边界框、轨迹信息、速度等内容。

### 4. `Tracks` 类

该类管理**单个**目标的轨迹和状态更新。

描述了如何使用卡尔曼滤波结合 IOU 进行多目标跟踪，支持两种 ID 分配方式：手动分配和使用 YOLOv8 提供的 ID。同时，代码实现了轨迹的创建、更新和删除机制，并提供了轨迹的可视化功能。